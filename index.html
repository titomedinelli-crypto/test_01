<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elemental Hunter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;700&family=Mali:wght@700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <style>
        :root {
            /* New Vibrant Color Palette */
            --bg-start: #f5f7fa;
            --bg-end: #c3cfe2;
            --primary-color: #ffffff;
            --secondary-color: #f8f9fa;
            --accent-color: #4a90e2;
            --border-color: #dfe9f3;
            --text-color: #3a3a3a;
            --text-light-color: #8c98a8;
            --correct-color: #7ed321;
            --wrong-color: #d0021b;
            --shadow-color: rgba(74, 144, 226, 0.2);

            /* Button Gradients */
            --btn-grad-1-start: #ffdde1;
            --btn-grad-1-end: #ee9ca7;
            --btn-grad-2-start: #f6d365;
            --btn-grad-2-end: #fda085;
            --btn-grad-3-start: #abe9cd;
            --btn-grad-3-end: #3eadcf;

            /* --- Element Category Colors (Vibrant) --- */
            --color-alkali-metal: #ff6b6b;
            --color-alkaline-earth: #ff9f43;
            --color-lanthanide: #ffeaa7;
            --color-actinide: #a29bfe;
            --color-transition-metal: #74b9ff;
            --color-metal: #55efc4;
            --color-metalloid: #81ecec;
            --color-nonmetal: #00cec9;
            --color-halogen: #fab1a0;
            --color-noble-gas: #dfe6e9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .app-container {
            width: 95%;
            max-width: 1400px;
            height: 95vh;
            max-height: 900px;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            box-shadow: 0 20px 60px var(--shadow-color), inset 0 0 20px rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative; 
        }

        .screen {
            width: 100%;
            height: 100%;
            padding: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .screen.active { 
            display: flex;
            animation: screen-fade-in 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) both;
        }
        
        .screen-header {
            position: absolute;
            top: 25px;
            left: 25px;
            z-index: 10;
        }

        h1 { 
            font-family: 'Playfair Display', serif;
            font-size: clamp(3.2rem, 8vw, 5rem);
            color: var(--accent-color); 
            margin-bottom: 10px; 
            text-shadow: 1px 1px 0 #fff, 2px 2px 5px var(--shadow-color);
        }
        h2 { 
            font-size: clamp(1rem, 2vw, 1.2rem); 
            color: var(--text-color); 
            opacity: 0.8; 
            margin-bottom: 20px; 
            text-align: center;
        }

        /* --- Main Menu & Difficulty Screens --- */
        #main-menu-screen { justify-content: center; }
        #main-menu-screen, #difficulty-screen { gap: 20px; }
        
        .menu-btn, .start-button, .option-btn {
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 20px var(--shadow-color), inset 0 -4px 0 rgba(0,0,0,0.1);
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            position: relative;
            overflow: hidden;
        }

        .menu-btn:hover, .start-button:hover, .option-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow-color), inset 0 -4px 0 rgba(0,0,0,0.1);
        }

        .menu-btn:active, .start-button:active, .option-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 10px var(--shadow-color), inset 0 -2px 0 rgba(0,0,0,0.1);
        }
        
        .menu-btn::after, .start-button::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.5) 0%, rgba(255, 255, 255, 0) 70%);
            transform: scale(0);
            transition: transform 0.5s ease;
        }

        .menu-btn:hover::after, .start-button:hover::after {
            transform: scale(2);
        }


        .menu-btn {
            padding: 20px 40px;
            font-size: 1.4rem;
            width: 80%;
            max-width: 450px;
            color: white;
            z-index: 5;
        }

        #btn-game-1 { background-image: linear-gradient(120deg, var(--btn-grad-1-start), var(--btn-grad-1-end)); }
        #btn-game-2 { background-image: linear-gradient(120deg, var(--btn-grad-2-start), var(--btn-grad-2-end)); }
        #btn-game-3 { background-image: linear-gradient(120deg, var(--btn-grad-3-start), var(--btn-grad-3-end)); }

        .main-menu-monster {
            position: absolute;
            bottom: -20px;
            right: -15px;
            width: clamp(200px, 20vw, 280px);
            height: auto;
            z-index: 2;
            animation: bobbing 3s ease-in-out infinite;
        }
        
        .main-menu-helper {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: clamp(120px, 15vw, 180px);
            height: auto;
            z-index: 2;
            animation: bobbing 3.5s ease-in-out infinite;
        }

        .helper-character {
            position: absolute;
            bottom: 5px;
            right: 10px;
            width: 120px;
            z-index: 2;
            animation: bobbing 2.5s ease-in-out infinite alternate;
        }
        #difficulty-screen .helper-character {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
        }


        /* --- Customization Screen --- */
        #customization-screen { justify-content: flex-start; overflow-y: auto; padding-bottom: 20px; }
        #customization-screen h1 { font-size: clamp(2rem, 4vw, 2.5rem); margin: 0; }
        #customization-screen h2 { font-size: clamp(0.9rem, 1.5vw, 1rem); margin-bottom: 5px; }
        #customization-screen p { margin-bottom: 5px; color: var(--text-color); font-size: 1.1rem; }
        
        #periodic-table-wrapper {
            width: 100%;
            max-width: 1200px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px 0;
            margin-bottom: 10px;
        }

        #periodic-table-grid {
            display: grid;
            grid-template-columns: repeat(18, minmax(0, 1fr));
            grid-template-rows: repeat(10, minmax(0, 1fr));
            gap: clamp(2px, 0.5vw, 4px);
            width: 100%;
            height: auto;
            max-height: 500px;
            aspect-ratio: 18 / 10;
        }

        .element-choice {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            line-height: 1.1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .element-choice:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .element-choice.selected { background-color: var(--accent-color); color: white; border-color: var(--accent-color); transform: scale(1.1); box-shadow: 0 5px 15px var(--shadow-color); }
        .element-choice .symbol { font-size: clamp(0.7rem, 1.5vw, 1.1rem); }
        .element-choice .number { font-size: clamp(0.5rem, 1vw, 0.7rem); opacity: 0.7; }
        
        .pt-placeholder {
            border: 2px dashed var(--border-color);
            border-radius: 4px;
            font-size: clamp(0.6rem, 1.2vw, 0.9rem);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-light-color);
            background-color: rgba(255, 255, 255, 0.5);
        }

        .start-button {
            padding: 15px 40px;
            font-size: 1.2rem;
            background-color: var(--accent-color);
            color: white;
            flex-shrink: 0;
        }
        .start-button:disabled { background-color: #aaa; color: #eee; cursor: not-allowed; box-shadow: 0 4px 15px rgba(0,0,0,0.1), inset 0 -4px 0 rgba(0,0,0,0.15); transform: none; }

        /* --- Game Screen --- */
        #game-screen { justify-content: flex-start; }
        .game-ui {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            margin-bottom: 5px;
            flex-shrink: 0;
        }
        .ui-box { font-size: 1.8rem; font-weight: bold; text-align: center; }
        #lives-display { display: flex; gap: 10px; align-items: center; }
        .life-icon-svg { width: 35px; height: 35px; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.2)); }
        .life-icon-svg path { fill: #ff7b7b; stroke: #c44a4a; stroke-width: 1; }
        .life-icon-svg.lost { transform: scale(0) rotate(180deg); opacity: 0; }
        
        .ui-icon-btn { cursor: pointer; width: 30px; height: 30px; color: var(--text-color); transition: color 0.2s ease, transform 0.2s ease; }
        .ui-icon-btn:hover { color: var(--accent-color); transform: scale(1.15) rotate(-10deg); }
        #sound-toggle .line { stroke: var(--wrong-color); stroke-width: 2; display: none; }
        #sound-toggle.muted .line { display: block; }

        .game-area { width: 100%; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        #drag-to-atom-container { height: 100%; width: 100%; display: flex; flex-direction: column; align-items: center; overflow-y: auto; padding-bottom: 20px; }
        #question-display-box { width: 100%; min-height: 110px; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .question-card {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #ffffff, #f1f3f5);
            border: 3px solid transparent;
            border-image: linear-gradient(45deg, var(--btn-grad-2-start), var(--btn-grad-3-end)) 1;
            border-radius: 20px;
            user-select: none;
            text-align: center;
            box-shadow: 0 10px 25px var(--shadow-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .question-card .symbol { font-size: 3rem; font-weight: bold; }
        .question-card .name { font-size: 0.9rem; color: var(--text-light-color); }

        #game-grid { display: grid; grid-template-columns: repeat(18, minmax(0, 1fr)); grid-template-rows: repeat(10, minmax(0, 1fr)); gap: 0; width: 100%; min-height: 550px; padding: 5px; }
        .grid-slot { border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 2px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: clamp(0.6rem, 1.2vw, 1rem); font-weight: bold; transition: all 0.2s ease; position: relative; aspect-ratio: 1 / 1; grid-column-start: var(--col); grid-row-start: var(--row); cursor: pointer; }
        .grid-slot:not([class*="category-"]) { background-color: rgba(233, 236, 239, 0.5); }
        .grid-slot:hover { transform: scale(1.1); z-index: 10; border-color: var(--accent-color); }
        .grid-slot.correct { background-color: var(--correct-color) !important; color: white; animation: pulse-correct 0.5s; cursor: default; border-color: var(--correct-color); }
        .grid-slot.correct .element-symbol { font-size: clamp(0.8rem, 1.5vw, 1.2rem); }
        .grid-slot.correct .element-name { font-size: clamp(0.4rem, 0.8vw, 0.5rem); font-weight: normal; }
        .placeholder-slot { background-color: #fff; border: 2px dashed; font-size: 0.8em; color: var(--text-light-color); cursor: default; }
        .placeholder-slot:hover { transform: none; }
        .placeholder-lanthanide { border-color: var(--color-lanthanide); }
        .placeholder-actinide { border-color: var(--color-actinide); }

        .category-alkali-metal { background-color: var(--color-alkali-metal); } .category-alkaline-earth { background-color: var(--color-alkaline-earth); } .category-lanthanide { background-color: var(--color-lanthanide); } .category-actinide { background-color: var(--color-actinide); } .category-transition-metal { background-color: var(--color-transition-metal); } .category-metal { background-color: var(--color-metal); } .category-metalloid { background-color: var(--color-metalloid); } .category-nonmetal { background-color: var(--color-nonmetal); } .category-halogen { background-color: var(--color-halogen); } .category-noble-gas { background-color: var(--color-noble-gas); }
        
        #color-legend { display: flex; flex-wrap: wrap; gap: 8px 12px; justify-content: center; padding: 5px; width: 100%; margin-top: 5px; flex-shrink: 0; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; }
        .legend-color-box { width: 12px; height: 12px; border: 1px solid #ccc; border-radius: 3px; }

        #multiple-choice-container { height: 100%; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; }
        #question-area { font-size: 2rem; text-align: center; margin-bottom: 20px; }
        #question-area .element-name { font-size: 3rem; font-weight: bold; color: var(--accent-color); }
        #options-area { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .option-btn { padding: 20px; min-width: 150px; font-size: 1.5rem; background-color: #fff; border: 2px solid var(--border-color); border-radius: 10px; }
        
        /* --- Game Over --- */
        #game-over-screen { gap: 15px; }
        .game-over-monster { width: 220px; height: auto; margin-bottom: -10px; }
        .game-over-monster .thumbs-up { animation: thumbs-up-bob 2s ease-in-out infinite; transform-origin: bottom center; }
        #game-over-title { font-family: 'Mali', cursive; font-size: 3rem; color: var(--accent-color); margin: 0; }
        #final-score { margin-bottom: 0; }
        #score-comparison { display: flex; gap: 30px; font-size: 1rem; margin-bottom: 15px; }
        #first-score { color: var(--text-light-color); }
        #high-score { color: var(--accent-color); font-weight: bold; }
        .game-over-buttons { display: flex; gap: 15px; margin-top: 20px; width: 90%; max-width: 500px; justify-content: center; }
        .game-over-buttons .start-button { flex: 1; }
        #home-btn-game-over { background-color: var(--secondary-color); color: var(--text-color); }

        /* --- Decorations & Feedback --- */
        .cheerleader-atom {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 90px;
            z-index: 20;
            animation: bobbing 4s ease-in-out infinite;
        }

        .sparkle-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px var(--btn-grad-2-start), 0 0 30px var(--btn-grad-2-end);
            animation: sparkle-anim 3s infinite ease-in-out;
            opacity: 0;
        }

        .sparkle:nth-child(1) { top: 20%; left: 15%; animation-delay: 0s; }
        .sparkle:nth-child(2) { top: 50%; left: 80%; animation-delay: 0.5s; width: 10px; height: 10px; }
        .sparkle:nth-child(3) { top: 80%; left: 10%; animation-delay: 1s; }
        .sparkle:nth-child(4) { top: 10%; left: 90%; animation-delay: 1.5s; width: 6px; height: 6px; }
        .sparkle:nth-child(5) { top: 65%; left: 30%; animation-delay: 2s; }

        @keyframes sparkle-anim {
            0%, 100% { opacity: 0; transform: scale(0.5) translateY(0); }
            50% { opacity: 1; transform: scale(1.2) translateY(-10px); }
        }

        .confetti {
            position: absolute;
            z-index: 1;
            top: -20px;
            animation: fall linear forwards;
        }
        #category-tooltip { position: absolute; display: none; background-color: #333; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; z-index: 1000; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: translateX(-50%); }
        .feedback { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; font-weight: bold; opacity: 0; animation: fade-out 1s; z-index: 100; text-shadow: 3px 3px 5px var(--shadow-color); }
        .feedback.correct { color: var(--correct-color); }
        .feedback.wrong { color: var(--wrong-color); animation: fade-shake 1s; }
        
        @keyframes bobbing { 0% { transform: translateY(0); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0); } }
        @keyframes thumbs-up-bob { 0% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }
        @keyframes fade-out { from { opacity: 1; transform: translate(-50%, -50%) scale(1); } to { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }
        @keyframes fade-shake { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 10%, 30% { transform: translate(-55%, -50%) rotate(-5deg); } 20%, 40% { transform: translate(-45%, -50%) rotate(5deg); } 50% { opacity: 1; } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }
        @keyframes pulse-correct { from { transform: scale(1); } 50% { transform: scale(1.1); box-shadow: 0 0 15px var(--correct-color); } to { transform: scale(1); } }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        @keyframes screen-fade-in {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
    </style>
</head>
<body>
    <svg width="0" height="0" style="position:absolute;">
        <defs>
            <radialGradient id="grad-atom" cx="50%" cy="50%" r="50%" fx="30%" fy="30%">
                <stop offset="0%" style="stop-color:rgb(220, 235, 255);stop-opacity:1" />
                <stop offset="100%" style="stop-color:rgb(160, 196, 255);stop-opacity:1" />
            </radialGradient>
            <radialGradient id="grad-monster-yellow" cx="50%" cy="50%" r="50%" fx="30%" fy="30%">
                <stop offset="0%" style="stop-color:rgb(255, 235, 173);stop-opacity:1" />
                <stop offset="100%" style="stop-color:rgb(250, 213, 100);stop-opacity:1" />
            </radialGradient>
            <filter id="glow">
                <feGaussianBlur stdDeviation="3.5" result="coloredBlur"/>
                <feMerge>
                    <feMergeNode in="coloredBlur"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>
        </defs>
    </svg>

    <div class="app-container">
        <div id="main-menu-screen" class="screen active">
             <div class="sparkle-container">
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
            </div>
            <h1>Elemental Hunter</h1>
            <h2>เลือกโหมดเกม</h2>
            <button id="btn-game-1" class="menu-btn game-select-btn" data-mode="drag_to_atom">เกมทายเลขอะตอม</button>
            <button id="btn-game-2" class="menu-btn game-select-btn" data-mode="guess_symbol">เกมทายตัวย่อธาตุ</button>
            <button id="btn-game-3" class="menu-btn game-select-btn" data-mode="guess_property">เกมทายคุณสมบัติ</button>
            
             <svg class="main-menu-helper" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <g filter="url(#glow)">
                    <circle cx="50" cy="50" r="25" fill="url(#grad-atom)" />
                    <circle cx="50" cy="50" r="22" fill="#fff"/>
                    <!-- Face -->
                    <circle cx="42" cy="45" r="3" fill="#3a3a3a"/>
                    <circle cx="58" cy="45" r="3" fill="#3a3a3a"/>
                    <path d="M 45 55 Q 50 60, 55 55" stroke="#3a3a3a" stroke-width="2" fill="none" stroke-linecap="round"/>
                    
                    <!-- Animated Electrons -->
                    <g style="transform-origin: 50px 50px;">
                        <circle cx="50" cy="50" r="4" fill="#ff6b6b">
                            <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="4s" repeatCount="indefinite" />
                        </circle>
                    </g>
                    <g style="transform-origin: 50px 50px;">
                        <circle cx="50" cy="10" r="4" fill="#74b9ff">
                             <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="2.5s" repeatCount="indefinite" />
                        </circle>
                    </g>
                     <g style="transform-origin: 50px 50px;">
                        <circle cx="15" cy="30" r="4" fill="#55efc4">
                             <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="3s" repeatCount="indefinite" />
                        </circle>
                    </g>
                </g>
            </svg>

            <svg class="main-menu-monster" viewBox="0 0 162 122" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(3px 5px 8px var(--shadow-color));">
                <path d="M125.798 121.325C124.789 119.533 123.018 117.433 121.034 116.325C113.88 112.228 102.583 102.738 98.7984 96.1251C95.222 89.8451 94.6293 81.652 94.7984 74.3251C94.9844 66.277 96.0028 57.5192 101.498 51.5251C107.781 44.6468 114.908 43.1537 122.798 44.1251C128.603 44.8211 133.433 47.7951 137.798 51.5251C142.062 55.1584 146.401 60.8528 148.298 67.3251C149.522 71.5541 150.119 76.529 149.498 80.9251C148.835 85.6021 146.992 90.6407 144.398 94.5251C138.804 102.946 131.503 111.439 125.798 121.325Z" fill="url(#grad-monster-yellow)"/>
                <path d="M35.1984 39.5251C35.9221 38.3073 37.0674 36.8123 38.4984 35.9251C42.8594 33.1971 49.3374 27.6521 52.5984 23.3251C55.6664 19.2311 56.6334 14.5021 54.8984 9.92508C53.0234 5.01308 48.0124 1.79408 42.9984 1.32508C36.9144 0.749082 30.6854 2.87108 25.5984 6.72508C20.6134 10.4951 15.6884 16.4801 13.5984 23.3251C12.2104 27.7941 11.8314 33.0071 13.5984 37.7251C15.5224 42.8421 20.3504 47.7801 25.5984 51.5251C31.2824 55.5911 37.9574 58.0771 44.1984 57.5251" id="Vector-2" fill="#8EBD9D"/>
                <path d="M161.5 59.5C161.5 61.5 159.667 69.8333 158.5 72.5C155.5 79.5 149.667 86.8333 145.5 90.5C136.5 98.5 125.667 111.333 121.5 116C117.833 120.167 113.833 127.333 112.5 129.5C111.167 131.667 106.833 138.333 105.5 139.5C97.8333 146.167 81.3333 150.333 72 150.5C62.6667 150.667 47.8333 146.167 40.5 141.5C31.3333 135.667 13.3333 119.333 8.5 112.5C-1.5 98.5 -1 83.5 2 73C5.5 61 14.5 44 25.5 35.5C31.5 30.5 40.5 25.5 47 23.5C51.239 22.251 55.5724 22.251 59.5 23.5C64.5 25 76 29 82 31C88 33 97.8333 36.1667 101.5 37.5C108.5 40 120.333 42.1667 125.5 43.5C136.5 46.5 147.5 51.1667 152 54C155.245 56.126 158.579 56.126 161.5 54" stroke="#1B475D" stroke-width="3" stroke-linecap="round"/>
            </svg>
        </div>

        <div id="difficulty-screen" class="screen">
            <div class="screen-header">
                <svg id="home-btn-difficulty" class="ui-icon-btn" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z"/>
                </svg>
            </div>
            <h1>เลือกระดับความยาก</h1>
            <button class="menu-btn difficulty-btn" data-difficulty="easy" style="background-image: linear-gradient(120deg, var(--btn-grad-3-start), var(--btn-grad-3-end));">ง่าย</button>
            <button class="menu-btn difficulty-btn" data-difficulty="medium" style="background-image: linear-gradient(120deg, var(--btn-grad-2-start), var(--btn-grad-2-end));">กลาง</button>
            <button class="menu-btn difficulty-btn" data-difficulty="hard" style="background-image: linear-gradient(120deg, var(--btn-grad-1-start), var(--btn-grad-1-end));">ยาก</button>
            <svg class="helper-character" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                 <g filter="url(#glow)">
                    <circle cx="50" cy="50" r="25" fill="url(#grad-atom)" />
                    <circle cx="50" cy="50" r="22" fill="#fff"/>
                    <!-- Face -->
                    <circle cx="42" cy="45" r="3" fill="#3a3a3a"/>
                    <circle cx="58" cy="45" r="3" fill="#3a3a3a"/>
                    <path d="M 45 55 Q 50 60, 55 55" stroke="#3a3a3a" stroke-width="2" fill="none" stroke-linecap="round"/>
                    
                    <!-- Animated Electrons -->
                     <g style="transform-origin: 50px 50px;">
                        <circle cx="50" cy="50" r="4" fill="#ff6b6b">
                            <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="4s" repeatCount="indefinite" />
                        </circle>
                    </g>
                    <g style="transform-origin: 50px 50px;">
                        <circle cx="50" cy="10" r="4" fill="#74b9ff">
                             <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="2.5s" repeatCount="indefinite" />
                        </circle>
                    </g>
                     <g style="transform-origin: 50px 50px;">
                        <circle cx="15" cy="30" r="4" fill="#55efc4">
                             <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="3s" repeatCount="indefinite" />
                        </circle>
                    </g>
                </g>
            </svg>
        </div>

        <div id="customization-screen" class="screen">
            <div class="screen-header">
                <svg id="home-btn-customization" class="ui-icon-btn" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z"/>
                </svg>
            </div>
            <h1 id="customization-title">เลือกธาตุ</h1>
            <h2>เลือกธาตุที่จะเล่น (อย่างน้อย 5 ธาตุ)</h2>
            <p id="element-count">เลือกแล้ว 0 ธาตุ</p>
            <div id="periodic-table-wrapper">
                <div id="periodic-table-grid"></div>
            </div>
            <button class="start-button" id="start-game-btn" disabled>เริ่มเกม</button>
            <svg class="helper-character" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                 <g filter="url(#glow)">
                    <circle cx="50" cy="50" r="25" fill="url(#grad-atom)" />
                    <circle cx="50" cy="50" r="22" fill="#fff"/>
                    <!-- Face -->
                    <circle cx="42" cy="45" r="3" fill="#3a3a3a"/>
                    <circle cx="58" cy="45" r="3" fill="#3a3a3a"/>
                    <path d="M 45 55 Q 50 60, 55 55" stroke="#3a3a3a" stroke-width="2" fill="none" stroke-linecap="round"/>
                    
                    <!-- Animated Electrons -->
                     <g style="transform-origin: 50px 50px;">
                        <circle cx="50" cy="50" r="4" fill="#ff6b6b">
                            <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="4s" repeatCount="indefinite" />
                        </circle>
                    </g>
                    <g style="transform-origin: 50px 50px;">
                        <circle cx="50" cy="10" r="4" fill="#74b9ff">
                             <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="2.5s" repeatCount="indefinite" />
                        </circle>
                    </g>
                     <g style="transform-origin: 50px 50px;">
                        <circle cx="15" cy="30" r="4" fill="#55efc4">
                             <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="3s" repeatCount="indefinite" />
                        </circle>
                    </g>
                </g>
            </svg>
        </div>

        <div id="game-screen" class="screen">
            <div class="game-ui">
                <div class="ui-box" style="display: flex; align-items: center; gap: 15px;">
                     <svg id="home-btn" class="ui-icon-btn" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z"/>
                    </svg>
                    <div id="lives-display"></div>
                </div>
                <div id="timer-display" class="ui-box">01:30</div>
                <div class="ui-box" style="display: flex; align-items: center; gap: 20px;">
                    <div id="score-display" style="font-size: 1.5rem;">Score: 0</div>
                    <svg id="sound-toggle" class="ui-icon-btn" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.84 14,18.7V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z" />
                        <line class="line" x1="1" y1="1" x2="23" y2="23" />
                    </svg>
                </div>
            </div>
            <div class="game-area">
                <div id="drag-to-atom-container" style="display: none;">
                    <div id="question-display-box"></div>
                    <div id="game-grid"></div>
                    <div id="color-legend"></div>
                </div>
                <div id="multiple-choice-container" style="display: none;">
                    <div id="question-area"></div>
                    <div id="options-area"></div>
                </div>
            </div>
            <svg class="cheerleader-atom" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <g filter="url(#glow)">
                    <circle cx="50" cy="50" r="25" fill="url(#grad-atom)" />
                    <circle cx="50" cy="50" r="22" fill="#fff"/>
                    <circle cx="42" cy="45" r="3" fill="#3a3a3a"/>
                    <circle cx="58" cy="45" r="3" fill="#3a3a3a"/>
                    <path d="M 45 58 Q 50 52, 55 58" stroke="#3a3a3a" stroke-width="2" fill="none" stroke-linecap="round"/>
                </g>
            </svg>
        </div>

        <div id="game-over-screen" class="screen">
            <svg class="game-over-monster" viewBox="0 0 200 150" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(3px 5px 8px var(--shadow-color));">
                <g class="thumbs-up">
                    <path d="M136.219 129.233C144.719 124.733 144.719 109.9 133.719 106.9C122.719 103.9 113.219 110.233 111.719 118.233" stroke="#1C5870" stroke-width="4" stroke-linecap="round"/>
                    <path d="M68.7188 129.233C60.2188 124.733 60.2188 109.9 71.2188 106.9C82.2188 103.9 91.7188 110.233 93.2188 118.233" stroke="#1C5870" stroke-width="4" stroke-linecap="round"/>
                </g>
                <path d="M165.719 86.8997C161.43 35.5663 124.219 -2.43367 76.7188 0.399663C29.2188 3.233 1.43047 50.8997 0.71875 100.9C0.00702813 150.9 29.2188 171.733 76.7188 147.233C124.219 122.733 170.007 138.233 165.719 86.8997Z" fill="url(#grad-monster-yellow)"/>
                <ellipse cx="65" cy="95" rx="12" ry="8" fill="#ffc6ff" opacity="0.7"/>
                <ellipse cx="135" cy="95" rx="12" ry="8" fill="#ffc6ff" opacity="0.7"/>
                
                <!-- Eyes -->
                <ellipse cx="100.5" cy="59.5" rx="28.5" ry="29.5" fill="white"/>
                <path d="M100 89C115.464 89 128 76.7025 128 61.5C128 46.2975 115.464 34 100 34C84.536 34 72 46.2975 72 61.5C72 76.7025 84.536 89 100 89Z" fill="#1C5870"/>
                <circle cx="90" cy="52" r="6" fill="white" opacity="0.8"/>
                <circle cx="108" cy="65" r="3" fill="white" opacity="0.6"/>

                <!-- Mouth -->
                <path d="M75 112 C 80 125, 120 125, 125 112 Z" fill="#D0021B"/>
                 <path d="M80 118 C 85 122, 115 122, 120 118 L 125 112 C 120 118, 80 118, 75 112 Z" fill="#ff7b7b"/>


                <path d="M49 20C49 20 44 9.5 50 5C56 0.5 58.5 0.5 58.5 0.5" stroke="#1C5870" stroke-width="4" stroke-linecap="round"/>
                <path d="M151 20C151 20 156 9.5 150 5C144 0.5 141.5 0.5 141.5 0.5" stroke="#1C5870" stroke-width="4" stroke-linecap="round"/>
            </svg>
            <h1 id="game-over-title">Good Job!</h1>
            <h2 id="final-score">คะแนนของคุณ: 0</h2>
            <div id="score-comparison">
                <p id="first-score"></p>
                <p id="high-score"></p>
            </div>
            <div class="game-over-buttons">
                <button class="start-button" id="play-again-btn">เล่นอีกครั้ง</button>
                <button class="start-button" id="home-btn-game-over">กลับหน้าหลัก</button>
            </div>
        </div>
        
        <div id="feedback-container"></div>
        <div id="category-tooltip"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA with categories ---
            const ELEMENTS_DATA = [
                { atomicNumber: 1, symbol: 'H', name: 'ไฮโดรเจน', category: 'นอนเมทัล' }, { atomicNumber: 2, symbol: 'He', name: 'ฮีเลียม', category: 'ก๊าซมีตระกูล' },
                { atomicNumber: 3, symbol: 'Li', name: 'ลิเทียม', category: 'โลหะแอลคาไล' }, { atomicNumber: 4, symbol: 'Be', name: 'เบริลเลียม', category: 'โลหะแอลคาไลน์เอิร์ท' },
                { atomicNumber: 5, symbol: 'B', name: 'โบรอน', category: 'เมทัลลอยด์' }, { atomicNumber: 6, symbol: 'C', name: 'คาร์บอน', category: 'นอนเมทัล' },
                { atomicNumber: 7, symbol: 'N', name: 'ไนโตรเจน', category: 'นอนเมทัล' }, { atomicNumber: 8, symbol: 'O', name: 'ออกซิเจน', category: 'นอนเมทัล' },
                { atomicNumber: 9, symbol: 'F', name: 'ฟลูออรีน', category: 'แฮโลเจน' }, { atomicNumber: 10, symbol: 'Ne', name: 'นีออน', category: 'ก๊าซมีตระกูล' },
                { atomicNumber: 11, symbol: 'Na', name: 'โซเดียม', category: 'โลหะแอลคาไล' }, { atomicNumber: 12, symbol: 'Mg', name: 'แมกนีเซียม', category: 'โลหะแอลคาไลน์เอิร์ท' },
                { atomicNumber: 13, symbol: 'Al', name: 'อะลูมิเนียม', category: 'โลหะ' }, { atomicNumber: 14, symbol: 'Si', name: 'ซิลิคอน', category: 'เมทัลลอยด์' },
                { atomicNumber: 15, symbol: 'P', name: 'ฟอสฟอรัส', category: 'นอนเมทัล' }, { atomicNumber: 16, symbol: 'S', name: 'กำมะถัน', category: 'นอนเมทัล' },
                { atomicNumber: 17, symbol: 'Cl', name: 'คลอรีน', category: 'แฮโลเจน' }, { atomicNumber: 18, symbol: 'Ar', name: 'อาร์กอน', category: 'ก๊าซมีตระกูล' },
                { atomicNumber: 19, symbol: 'K', name: 'โพแทสเซียม', category: 'โลหะแอลคาไล' }, { atomicNumber: 20, symbol: 'Ca', name: 'แคลเซียม', category: 'โลหะแอลคาไลน์เอิร์ท' },
                { atomicNumber: 21, symbol: 'Sc', name: 'สแคนเดียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 22, symbol: 'Ti', name: 'ไทเทเนียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 23, symbol: 'V', name: 'วาเนเดียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 24, symbol: 'Cr', name: 'โครเมียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 25, symbol: 'Mn', name: 'แมงกานีส', category: 'โลหะทรานซิชัน' }, { atomicNumber: 26, symbol: 'Fe', name: 'เหล็ก', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 27, symbol: 'Co', name: 'โคบอลต์', category: 'โลหะทรานซิชัน' }, { atomicNumber: 28, symbol: 'Ni', name: 'นิกเกิล', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 29, symbol: 'Cu', name: 'ทองแดง', category: 'โลหะทรานซิชัน' }, { atomicNumber: 30, symbol: 'Zn', name: 'สังกะสี', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 31, symbol: 'Ga', name: 'แกลเลียม', category: 'โลหะ' }, { atomicNumber: 32, symbol: 'Ge', name: 'เจอร์เมเนียม', category: 'เมทัลลอยด์' },
                { atomicNumber: 33, symbol: 'As', name: 'สารหนู', category: 'เมทัลลอยด์' }, { atomicNumber: 34, symbol: 'Se', name: 'ซีลีเนียม', category: 'นอนเมทัล' },
                { atomicNumber: 35, symbol: 'Br', name: 'โบรมีน', category: 'แฮโลเจน' }, { atomicNumber: 36, symbol: 'Kr', name: 'คริปทอน', category: 'ก๊าซมีตระกูล' },
                { atomicNumber: 37, symbol: 'Rb', name: 'รูบิเดียม', category: 'โลหะแอลคาไล' }, { atomicNumber: 38, symbol: 'Sr', name: 'สตรอนเชียม', category: 'โลหะแอลคาไลน์เอิร์ท' },
                { atomicNumber: 39, symbol: 'Y', name: 'อิตเทรียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 40, symbol: 'Zr', name: 'เซอร์โคเนียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 41, symbol: 'Nb', name: 'ไนโอเบียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 42, symbol: 'Mo', name: 'โมลิบดีนัม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 43, symbol: 'Tc', name: 'เทคนีเชียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 44, symbol: 'Ru', name: 'รูทีเนียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 45, symbol: 'Rh', name: 'โรเดียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 46, symbol: 'Pd', name: 'พัลลาเดียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 47, symbol: 'Ag', name: 'เงิน', category: 'โลหะทรานซิชัน' }, { atomicNumber: 48, symbol: 'Cd', name: 'แคดเมียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 49, symbol: 'In', name: 'อินเดียม', category: 'โลหะ' }, { atomicNumber: 50, symbol: 'Sn', name: 'ดีบุก', category: 'โลหะ' },
                { atomicNumber: 51, symbol: 'Sb', name: 'พลวง', category: 'เมทัลลอยด์' }, { atomicNumber: 52, symbol: 'Te', name: 'เทลลูเรียม', category: 'เมทัลลอยด์' },
                { atomicNumber: 53, symbol: 'I', name: 'ไอโอดีน', category: 'แฮโลเจน' }, { atomicNumber: 54, symbol: 'Xe', name: 'ซีนอน', category: 'ก๊าซมีตระกูล' },
                { atomicNumber: 55, symbol: 'Cs', name: 'ซีเซียม', category: 'โลหะแอลคาไล' }, { atomicNumber: 56, symbol: 'Ba', name: 'แบเรียม', category: 'โลหะแอลคาไลน์เอิร์ท' },
                { atomicNumber: 57, symbol: 'La', name: 'แลนทานัม', category: 'แลนทาไนด์' }, { atomicNumber: 58, symbol: 'Ce', name: 'ซีเรียม', category: 'แลนทาไนด์' },
                { atomicNumber: 59, symbol: 'Pr', name: 'เพรซีโอดิเมียม', category: 'แลนทาไนด์' }, { atomicNumber: 60, symbol: 'Nd', name: 'นีโอดิเมียม', category: 'แลนทาไนด์' },
                { atomicNumber: 61, symbol: 'Pm', name: 'โพรมีเทียม', category: 'แลนทาไนด์' }, { atomicNumber: 62, symbol: 'Sm', name: 'ซาแมเรียม', category: 'แลนทาไนด์' },
                { atomicNumber: 63, symbol: 'Eu', name: 'ยูโรเพียม', category: 'แลนทาไนด์' }, { atomicNumber: 64, symbol: 'Gd', name: 'แกโดลิเนียม', category: 'แลนทาไนด์' },
                { atomicNumber: 65, symbol: 'Tb', name: 'เทอร์เบียม', category: 'แลนทาไนด์' }, { atomicNumber: 66, symbol: 'Dy', name: 'ดิสโพรเซียม', category: 'แลนทาไนด์' },
                { atomicNumber: 67, symbol: 'Ho', name: 'โฮลเมียม', category: 'แลนทาไนด์' }, { atomicNumber: 68, symbol: 'Er', name: 'เออร์เบียม', category: 'แลนทาไนด์' },
                { atomicNumber: 69, symbol: 'Tm', name: 'ทูเลียม', category: 'แลนทาไนด์' }, { atomicNumber: 70, symbol: 'Yb', name: 'อิตเทอร์เบียม', category: 'แลนทาไนด์' },
                { atomicNumber: 71, symbol: 'Lu', name: 'ลูทีเชียม', category: 'แลนทาไนด์' }, { atomicNumber: 72, symbol: 'Hf', name: 'แฮฟเนียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 73, symbol: 'Ta', name: 'แทนทาลัม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 74, symbol: 'W', name: 'ทังสเตน', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 75, symbol: 'Re', name: 'รีเนียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 76, symbol: 'Os', name: 'ออสเมียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 77, symbol: 'Ir', name: 'อิริเดียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 78, symbol: 'Pt', name: 'แพลทินัม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 79, symbol: 'Au', name: 'ทองคำ', category: 'โลหะทรานซิชัน' }, { atomicNumber: 80, symbol: 'Hg', name: 'ปรอท', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 81, symbol: 'Tl', name: 'แทลเลียม', category: 'โลหะ' }, { atomicNumber: 82, symbol: 'Pb', name: 'ตะกั่ว', category: 'โลหะ' },
                { atomicNumber: 83, symbol: 'Bi', name: 'บิสมัท', category: 'โลหะ' }, { atomicNumber: 84, symbol: 'Po', name: 'โพโลเนียม', category: 'เมทัลลอยด์' },
                { atomicNumber: 85, symbol: 'At', name: 'แอสทาทีน', category: 'แฮโลเจน' }, { atomicNumber: 86, symbol: 'Rn', name: 'เรดอน', category: 'ก๊าซมีตระกูล' },
                { atomicNumber: 87, symbol: 'Fr', name: 'แฟรนเซียม', category: 'โลหะแอลคาไล' }, { atomicNumber: 88, symbol: 'Ra', name: 'เรเดียม', category: 'โลหะแอลคาไลน์เอิร์ท' },
                { atomicNumber: 89, symbol: 'Ac', name: 'แอกทิเนียม', category: 'แอกทิไนด์' }, { atomicNumber: 90, symbol: 'Th', name: 'ทอเรียม', category: 'แอกทิไนด์' },
                { atomicNumber: 91, symbol: 'Pa', name: 'โพรแทกทิเนียม', category: 'แอกทิไนด์' }, { atomicNumber: 92, symbol: 'U', name: 'ยูเรเนียม', category: 'แอกทิไนด์' },
                { atomicNumber: 93, symbol: 'Np', name: 'เนปทูเนียม', category: 'แอกทิไนด์' }, { atomicNumber: 94, symbol: 'Pu', name: 'พลูโทเนียม', category: 'แอกทิไนด์' },
                { atomicNumber: 95, symbol: 'Am', name: 'อะเมริเซียม', category: 'แอกทิไนด์' }, { atomicNumber: 96, symbol: 'Cm', name: 'คูเรียม', category: 'แอกทิไนด์' },
                { atomicNumber: 97, symbol: 'Bk', name: 'เบอร์คีเลียม', category: 'แอกทิไนด์' }, { atomicNumber: 98, symbol: 'Cf', name: 'แคลิฟอร์เนียม', category: 'แอกทิไนด์' },
                { atomicNumber: 99, symbol: 'Es', name: 'ไอน์สไตเนียม', category: 'แอกทิไนด์' }, { atomicNumber: 100, symbol: 'Fm', name: 'เฟอร์เมียม', category: 'แอกทิไนด์' },
                { atomicNumber: 101, symbol: 'Md', name: 'เมนเดลีเวียม', category: 'แอกทิไนด์' }, { atomicNumber: 102, symbol: 'No', name: 'โนเบเลียม', category: 'แอกทิไนด์' },
                { atomicNumber: 103, symbol: 'Lr', name: 'ลอว์เรนเซียม', category: 'แอกทิไนด์' }, { atomicNumber: 104, symbol: 'Rf', name: 'รัทเทอร์ฟอร์เดียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 105, symbol: 'Db', name: 'ดุบเนียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 106, symbol: 'Sg', name: 'ซีบอร์เกียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 107, symbol: 'Bh', name: 'โบห์เรียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 108, symbol: 'Hs', name: 'ฮัสเซียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 109, symbol: 'Mt', name: 'ไมต์เนเรียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 110, symbol: 'Ds', name: 'ดาร์มสตัดเทียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 111, symbol: 'Rg', name: 'เรินต์เกเนียม', category: 'โลหะทรานซิชัน' }, { atomicNumber: 112, symbol: 'Cn', name: 'โคเปอร์นิเซียม', category: 'โลหะทรานซิชัน' },
                { atomicNumber: 113, symbol: 'Nh', name: 'นิโฮเนียม', category: 'โลหะ' }, { atomicNumber: 114, symbol: 'Fl', name: 'ฟลีโรเวียม', category: 'โลหะ' },
                { atomicNumber: 115, symbol: 'Mc', name: 'มอสโกเวียม', category: 'โลหะ' }, { atomicNumber: 116, symbol: 'Lv', name: 'ลิเวอร์มอเรียม', category: 'โลหะ' },
                { atomicNumber: 117, symbol: 'Ts', name: 'เทนเนสซีน', category: 'แฮโลเจน' }, { atomicNumber: 118, symbol: 'Og', name: 'โอกาเนสซอน', category: 'ก๊าซมีตระกูล' }
            ];
            const ELEMENT_POSITIONS = { 
                1: { row: 1, col: 1 }, 2: { row: 1, col: 18 }, 3: { row: 2, col: 1 }, 4: { row: 2, col: 2 }, 5: { row: 2, col: 13 }, 6: { row: 2, col: 14 }, 7: { row: 2, col: 15 }, 8: { row: 2, col: 16 }, 9: { row: 2, col: 17 }, 10: { row: 2, col: 18 }, 11: { row: 3, col: 1 }, 12: { row: 3, col: 2 }, 13: { row: 3, col: 13 }, 14: { row: 3, col: 14 }, 15: { row: 3, col: 15 }, 16: { row: 3, col: 16 }, 17: { row: 3, col: 17 }, 18: { row: 3, col: 18 }, 19: { row: 4, col: 1 }, 20: { row: 4, col: 2 }, 21: { row: 4, col: 3 }, 22: { row: 4, col: 4 }, 23: { row: 4, col: 5 }, 24: { row: 4, col: 6 }, 25: { row: 4, col: 7 }, 26: { row: 4, col: 8 }, 27: { row: 4, col: 9 }, 28: { row: 4, col: 10 }, 29: { row: 4, col: 11 }, 30: { row: 4, col: 12 }, 31: { row: 4, col: 13 }, 32: { row: 4, col: 14 }, 33: { row: 4, col: 15 }, 34: { row: 4, col: 16 }, 35: { row: 4, col: 17 }, 36: { row: 4, col: 18 }, 37: { row: 5, col: 1 }, 38: { row: 5, col: 2 }, 39: { row: 5, col: 3 }, 40: { row: 5, col: 4 }, 41: { row: 5, col: 5 }, 42: { row: 5, col: 6 }, 43: { row: 5, col: 7 }, 44: { row: 5, col: 8 }, 45: { row: 5, col: 9 }, 46: { row: 5, col: 10 }, 47: { row: 5, col: 11 }, 48: { row: 5, col: 12 }, 49: { row: 5, col: 13 }, 50: { row: 5, col: 14 }, 51: { row: 5, col: 15 }, 52: { row: 5, col: 16 }, 53: { row: 5, col: 17 }, 54: { row: 5, col: 18 }, 55: { row: 6, col: 1 }, 56: { row: 6, col: 2 }, 57: { row: 9, col: 3 }, 58: { row: 9, col: 4 }, 59: { row: 9, col: 5 }, 60: { row: 9, col: 6 }, 61: { row: 9, col: 7 }, 62: { row: 9, col: 8 }, 63: { row: 9, col: 9 }, 64: { row: 9, col: 10 }, 65: { row: 9, col: 11 }, 66: { row: 9, col: 12 }, 67: { row: 9, col: 13 }, 68: { row: 9, col: 14 }, 69: { row: 9, col: 15 }, 70: { row: 9, col: 16 }, 71: { row: 9, col: 17 }, 72: { row: 6, col: 4 }, 73: { row: 6, col: 5 }, 74: { row: 6, col: 6 }, 75: { row: 6, col: 7 }, 76: { row: 6, col: 8 }, 77: { row: 6, col: 9 }, 78: { row: 6, col: 10 }, 79: { row: 6, col: 11 }, 80: { row: 6, col: 12 }, 81: { row: 6, col: 13 }, 82: { row: 6, col: 14 }, 83: { row: 6, col: 15 }, 84: { row: 6, col: 16 }, 85: { row: 6, col: 17 }, 86: { row: 6, col: 18 }, 87: { row: 7, col: 1 }, 88: { row: 7, col: 2 }, 89: { row: 10, col: 3 }, 90: { row: 10, col: 4 }, 91: { row: 10, col: 5 }, 92: { row: 10, col: 6 }, 93: { row: 10, col: 7 }, 94: { row: 10, col: 8 }, 95: { row: 10, col: 9 }, 96: { row: 10, col: 10 }, 97: { row: 10, col: 11 }, 98: { row: 10, col: 12 }, 99: { row: 10, col: 13 }, 100: { row: 10, col: 14 }, 101: { row: 10, col: 15 }, 102: { row: 10, col: 16 }, 103: { row: 10, col: 17 }, 104: { row: 7, col: 4 }, 105: { row: 7, col: 5 }, 106: { row: 7, col: 6 }, 107: { row: 7, col: 7 }, 108: { row: 7, col: 8 }, 109: { row: 7, col: 9 }, 110: { row: 7, col: 10 }, 111: { row: 7, col: 11 }, 112: { row: 7, col: 12 }, 113: { row: 7, col: 13 }, 114: { row: 7, col: 14 }, 115: { row: 7, col: 15 }, 116: { row: 7, col: 16 }, 117: { row: 7, col: 17 }, 118: { row: 7, col: 18 }
            };
            const CATEGORY_DIFFICULTY = {
                easy: ['โลหะแอลคาไล', 'ก๊าซมีตระกูล'],
                medium: ['โลหะแอลคาไล', 'ก๊าซมีตระกูล', 'แฮโลเจน', 'โลหะแอลคาไลน์เอิร์ท', 'นอนเมทัล', 'โลหะทรานซิชัน', 'เมทัลลอยด์'],
                hard: [...new Set(ELEMENTS_DATA.map(el => el.category))] // All unique categories
            };
            const TRIVIA_QUESTIONS = [
                { question_text: "ในอากาศมีแก๊สอะไรมากที่สุด?", correct_answer_symbol: "N", difficulty: "easy" },
                { question_text: "ธาตุใดที่ใช้ทำไส้ดินสอ?", correct_answer_symbol: "C", difficulty: "easy" },
                { question_text: "ธาตุใดเป็นส่วนประกอบหลักของน้ำ?", correct_answer_symbol: "O", difficulty: "easy" },
                { question_text: "ในยาสีฟันมีธาตุใดเป็นส่วนประกอบหลัก?", correct_answer_symbol: "F", difficulty: "medium" },
                { question_text: "ธาตุที่เป็นโลหะของเหลวที่อุณหภูมิห้องคือ?", correct_answer_symbol: "Hg", difficulty: "medium" },
                { question_text: "ธาตุใดจำเป็นต่อการสร้างกระดูกและฟัน?", correct_answer_symbol: "Ca", difficulty: "medium" },
                { question_text: "ธาตุใดที่เป็นส่วนประกอบสำคัญของเหล็กกล้าไร้สนิม?", correct_answer_symbol: "Cr", difficulty: "hard" },
                { question_text: "ธาตุใดที่ตั้งชื่อตามดาวเคราะห์แคระพลูโต?", correct_answer_symbol: "Pu", difficulty: "hard" },
            ];

            // --- DOM Elements & Game State ---
            const screens = { mainMenu: document.getElementById('main-menu-screen'), difficulty: document.getElementById('difficulty-screen'), customization: document.getElementById('customization-screen'), game: document.getElementById('game-screen'), gameOver: document.getElementById('game-over-screen') };
            const gameModeContainers = { drag_to_atom: document.getElementById('drag-to-atom-container'), multiple_choice: document.getElementById('multiple-choice-container') };
            const elementCountDisplay = document.getElementById('element-count');
            const startGameBtn = document.getElementById('start-game-btn');
            const playAgainBtn = document.getElementById('play-again-btn');
            const livesDisplay = document.getElementById('lives-display');
            const timerDisplay = document.getElementById('timer-display');
            const scoreDisplay = document.getElementById('score-display');
            const finalScoreDisplay = document.getElementById('final-score');
            const firstScoreDisplay = document.getElementById('first-score');
            const highScoreDisplay = document.getElementById('high-score');
            const feedbackContainer = document.getElementById('feedback-container');
            const categoryTooltip = document.getElementById('category-tooltip');
            const soundToggle = document.getElementById('sound-toggle');
            const homeBtn = document.getElementById('home-btn');
            const homeBtnGameOver = document.getElementById('home-btn-game-over');
            const homeBtnDifficulty = document.getElementById('home-btn-difficulty');
            const homeBtnCustomization = document.getElementById('home-btn-customization');

            let gameState = { mode: null, difficulty: null };
            let propertyQuestionsBank = [];
            let selectedElements = new Set();
            let gameElementsQueue = [];
            let lives, score, timeLeft, timerInterval, longPressTimer;
            
            // --- Audio ---
            let uiSynth, correctSynth, wrongSynth, bgMusic, isAudioInitialized = false;

            async function initAudio() {
                if (isAudioInitialized || typeof Tone === 'undefined') {
                     if (typeof Tone === 'undefined' && !window.toneJsWarningIssued) {
                        console.warn("Tone.js library not loaded. Audio will be disabled.");
                        window.toneJsWarningIssued = true; 
                     }
                    return;
                }

                try {
                    await Tone.start();
                    
                    uiSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 } }).toDestination();
                    correctSynth = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
                    wrongSynth = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.2 } }).toDestination();
                    
                    const bgSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: "amsine", harmonicity: 1.2 },
                        envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.2 }
                    }).toDestination();
                    bgSynth.volume.value = -12;

                    bgMusic = new Tone.Sequence((time, note) => {
                        bgSynth.triggerAttackRelease(note, "8n", time);
                    }, ["C4", "E4", "G4", "B4"], "4n");
                    
                    Tone.Transport.bpm.value = 100;
                    isAudioInitialized = true;
                    console.log("Audio Initialized");
                } catch(e) {
                     console.error("Audio initialization failed. Audio will be disabled.", e);
                     isAudioInitialized = false;
                }
            }

            // --- Navigation ---
            const showScreen = (screenName) => {
                Object.values(screens).forEach(screen => screen.classList.remove('active'));
                screens[screenName].classList.add('active');
            };
            
            const returnToMainMenu = async () => {
                await initAudio();
                if (isAudioInitialized && uiSynth) uiSynth.triggerAttackRelease("A4", "8n");

                clearInterval(timerInterval);
                clearTimeout(longPressTimer);
                if(isAudioInitialized && typeof Tone !== 'undefined' && Tone.Transport.state === 'started') {
                    bgMusic.stop();
                    Tone.Transport.stop();
                }
                hideCategoryTooltip();
                
                // Clear confetti
                screens.gameOver.querySelectorAll('.confetti').forEach(c => c.remove());

                selectedElements.clear();
                document.querySelectorAll('.element-choice.selected').forEach(el => el.classList.remove('selected'));
                elementCountDisplay.textContent = `เลือกแล้ว 0 ธาตุ`;
                startGameBtn.disabled = true;
                
                showScreen('mainMenu');
            };

            document.querySelectorAll('.game-select-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    await initAudio();
                    if (isAudioInitialized && uiSynth) uiSynth.triggerAttackRelease("C5", "8n");
                    gameState.mode = btn.dataset.mode;
                    if (gameState.mode === 'guess_property') {
                        showScreen('difficulty');
                    } else {
                        document.getElementById('customization-title').textContent = btn.textContent;
                        showScreen('customization');
                    }
                });
            });

            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    await initAudio();
                    if (isAudioInitialized && uiSynth) uiSynth.triggerAttackRelease("C5", "8n");
                    gameState.difficulty = btn.dataset.difficulty;
                    propertyQuestionsBank = generatePropertyQuestions(gameState.difficulty);
                    startGame();
                });
            });
            
            const generatePropertyQuestions = (difficulty) => {
                const questions = [];
                const allowedCategories = CATEGORY_DIFFICULTY[difficulty];
                
                const availableTrivia = TRIVIA_QUESTIONS.filter(q => {
                    if (difficulty === 'easy') return q.difficulty === 'easy';
                    if (difficulty === 'medium') return q.difficulty === 'easy' || q.difficulty === 'medium';
                    return true;
                });

                while (questions.length < 100) {
                    if (availableTrivia.length > 0 && Math.random() < 0.4) {
                        const trivia = availableTrivia[Math.floor(Math.random() * availableTrivia.length)];
                        const correctAnswer = ELEMENTS_DATA.find(el => el.symbol === trivia.correct_answer_symbol);
                        if (!correctAnswer) continue;

                        const distractorPool = ELEMENTS_DATA.filter(el => el.atomicNumber !== correctAnswer.atomicNumber);
                        const choices = new Set([correctAnswer]);
                        while (choices.size < 4 && distractorPool.length > 0) {
                            const randomIndex = Math.floor(Math.random() * distractorPool.length);
                            choices.add(distractorPool.splice(randomIndex, 1)[0]);
                        }
                        if (choices.size === 4) {
                            questions.push({
                                type: 'trivia',
                                questionText: trivia.question_text,
                                correctAnswer: correctAnswer,
                                choices: Array.from(choices).sort(() => Math.random() - 0.5)
                            });
                        }
                    } else {
                        const metalCategories = ['โลหะแอลคาไล', 'โลหะแอลคาไลน์เอิร์ท', 'โลหะทรานซิชัน', 'โลหะ', 'แลนทาไนด์', 'แอกทิไนด์'];
                        const nonMetalCategories = ['ก๊าซมีตระกูล', 'แฮโลเจน', 'นอนเมทัล', 'เมทัลลอยด์'];
                        const questionCategory = allowedCategories[Math.floor(Math.random() * allowedCategories.length)];
                        const possibleCorrectAnswers = ELEMENTS_DATA.filter(el => el.category === questionCategory);
                        if (possibleCorrectAnswers.length === 0) continue;

                        const correctAnswer = possibleCorrectAnswers[Math.floor(Math.random() * possibleCorrectAnswers.length)];
                        
                        let distractorPool;
                        if (difficulty === 'easy') {
                            const isMetalQuestion = metalCategories.includes(questionCategory);
                            distractorPool = isMetalQuestion 
                                ? ELEMENTS_DATA.filter(el => nonMetalCategories.includes(el.category))
                                : ELEMENTS_DATA.filter(el => metalCategories.includes(el.category));
                        } else {
                            distractorPool = ELEMENTS_DATA.filter(el => el.category !== questionCategory);
                        }
                        distractorPool = distractorPool.filter(el => el.atomicNumber !== correctAnswer.atomicNumber);

                        const choices = new Set([correctAnswer]);
                        while (choices.size < 4 && distractorPool.length > 0) {
                            const randomIndex = Math.floor(Math.random() * distractorPool.length);
                            choices.add(distractorPool.splice(randomIndex, 1)[0]);
                        }
                        
                        if (choices.size === 4) {
                            questions.push({
                                type: 'category',
                                questionText: `ธาตุใดต่อไปนี้จัดอยู่ในกลุ่ม <span class="element-name">${questionCategory}</span>?`,
                                correctAnswer: correctAnswer,
                                choices: Array.from(choices).sort(() => Math.random() - 0.5)
                            });
                        }
                    }
                }
                return questions;
            };

            const populateCustomizationGrid = () => {
                const periodicTableGrid = document.getElementById('periodic-table-grid');
                periodicTableGrid.innerHTML = '';

                ELEMENTS_DATA.forEach(el => {
                    const pos = ELEMENT_POSITIONS[el.atomicNumber];
                    if (!pos) return;

                    const choice = document.createElement('div');
                    choice.className = 'element-choice';
                    choice.dataset.atomicNumber = el.atomicNumber;
                    choice.innerHTML = `<div class="number">${el.atomicNumber}</div><div class="symbol">${el.symbol}</div>`;
                    
                    choice.style.gridColumnStart = pos.col;
                    choice.style.gridRowStart = pos.row;

                    choice.addEventListener('click', (e) => {
                        const choiceDiv = e.currentTarget;
                        const atomicNum = parseInt(choiceDiv.dataset.atomicNumber);
                        if (selectedElements.has(atomicNum)) {
                            selectedElements.delete(atomicNum);
                            choiceDiv.classList.remove('selected');
                        } else {
                            selectedElements.add(atomicNum);
                            choiceDiv.classList.add('selected');
                        }
                        elementCountDisplay.textContent = `เลือกแล้ว ${selectedElements.size} ธาตุ`;
                        startGameBtn.disabled = selectedElements.size < 5;
                    });
                    periodicTableGrid.appendChild(choice);
                });

                const placeholderLa = document.createElement('div');
                placeholderLa.className = 'pt-placeholder';
                placeholderLa.style.gridColumnStart = 3;
                placeholderLa.style.gridRowStart = 6;
                placeholderLa.textContent = '57-71';
                periodicTableGrid.appendChild(placeholderLa);

                const placeholderAc = document.createElement('div');
                placeholderAc.className = 'pt-placeholder';
                placeholderAc.style.gridColumnStart = 3;
                placeholderAc.style.gridRowStart = 7;
                placeholderAc.textContent = '89-103';
                periodicTableGrid.appendChild(placeholderAc);
            };

            const startGame = () => {
                lives = 3; 
                score = 0;
                
                if (gameState.mode === 'drag_to_atom' || gameState.mode === 'guess_symbol') {
                    timeLeft = selectedElements.size * 20;
                } else { // guess_property
                    timeLeft = 90;
                }
                
                Object.values(gameModeContainers).forEach(c => c.style.display = 'none');

                if (gameState.mode === 'guess_property') {
                    gameElementsQueue = [...propertyQuestionsBank].sort(() => Math.random() - 0.5).slice(0, 10);
                     if (gameElementsQueue.length < 1) {
                        alert('เกิดข้อผิดพลาดในการสร้างคำถามสำหรับระดับความยากนี้');
                        showScreen('mainMenu');
                        return;
                    }
                    gameModeContainers.multiple_choice.style.display = 'flex';
                    displayNextPropertyQuestion();
                } else {
                    const elementsToPlay = ELEMENTS_DATA.filter(el => selectedElements.has(el.atomicNumber));
                    gameElementsQueue = [...elementsToPlay].sort(() => Math.random() - 0.5);
                    if (gameState.mode === 'drag_to_atom') {
                        gameModeContainers.drag_to_atom.style.display = 'flex';
                        setupAtomPlacementGame();
                    } else { // guess_symbol
                        gameModeContainers.multiple_choice.style.display = 'flex';
                        displayNextSymbolQuestion();
                    }
                }
                
                updateUI();
                if (isAudioInitialized && typeof Tone !== 'undefined' && !Tone.getDestination().mute) {
                    Tone.Transport.start();
                    bgMusic.start(0);
                }
                showScreen('game');
                startTimer();
            };
            
            const getScoreKeys = () => {
                let baseKey = `elementalhunter_${gameState.mode}`;
                if (gameState.mode === 'guess_property') {
                    baseKey += `_${gameState.difficulty}`;
                }
                return {
                    first: `${baseKey}_first_score`,
                    high: `${baseKey}_high_score`
                };
            };

            function createConfetti() {
                const confettiContainer = screens.gameOver;
                const colors = ['#FAD564', '#D3DC7C', '#8EBD9D', '#ffadad', '#a0c4ff', '#bdb2ff'];
                confettiContainer.querySelectorAll('.confetti').forEach(c => c.remove());

                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.width = `${Math.random() * 10 + 5}px`;
                    confetti.style.height = confetti.style.width;
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.animationDuration = `${Math.random() * 3 + 4}s`;
                    confetti.style.animationDelay = `${Math.random() * 2}s`;
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    confettiContainer.appendChild(confetti);
                }
            }

            const endGame = () => {
                clearInterval(timerInterval);
                clearTimeout(longPressTimer);
                if(isAudioInitialized && typeof Tone !== 'undefined' && Tone.Transport.state === 'started') {
                    bgMusic.stop();
                    Tone.Transport.stop();
                }
                hideCategoryTooltip();
                finalScoreDisplay.textContent = `คะแนนของคุณ: ${score}`;

                const { first: firstScoreKey, high: highScoreKey } = getScoreKeys();

                let firstScore = localStorage.getItem(firstScoreKey);
                if (firstScore === null) {
                    firstScore = score;
                    localStorage.setItem(firstScoreKey, score.toString());
                }
                firstScoreDisplay.textContent = `คะแนนครั้งแรก: ${firstScore}`;

                let highScore = localStorage.getItem(highScoreKey);
                if (highScore === null || score > parseInt(highScore)) {
                    highScore = score;
                    localStorage.setItem(highScoreKey, score.toString());
                }
                highScoreDisplay.textContent = `คะแนนสูงสุด: ${highScore}`;

                showScreen('gameOver');
                createConfetti();
            };

            const updateUI = () => {
                const heartSVG = (isLost) => `
                    <svg class="life-icon-svg ${isLost ? 'lost' : ''}" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>`;
                livesDisplay.innerHTML = Array.from({ length: 3 }, (_, i) => heartSVG(i >= lives)).join('');
                scoreDisplay.textContent = `Score: ${score}`;
                timerDisplay.textContent = `${String(Math.floor(timeLeft / 60)).padStart(2, '0')}:${String(timeLeft % 60).padStart(2, '0')}`;
            };
            const startTimer = () => {
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateUI();
                    if (timeLeft <= 0) endGame();
                }, 1000);
            };
            
            const setupAtomPlacementGame = () => {
                const gameGrid = document.getElementById('game-grid');
                gameGrid.innerHTML = '';
                const elementsInGame = ELEMENTS_DATA.filter(el => selectedElements.has(el.atomicNumber));

                const categoryToClass = {
                    'นอนเมทัล': 'nonmetal', 'โลหะแอลคาไล': 'alkali-metal', 'โลหะแอลคาไลน์เอิร์ท': 'alkaline-earth',
                    'เมทัลลอยด์': 'metalloid', 'แฮโลเจน': 'halogen', 'ก๊าซมีตระกูล': 'noble-gas',
                    'โลหะทรานซิชัน': 'transition-metal', 'โลหะ': 'metal', 'แลนทาไนด์': 'lanthanide', 'แอกทิไนด์': 'actinide'
                };

                const placeholderLa = document.createElement('div');
                placeholderLa.className = 'grid-slot placeholder-slot';
                placeholderLa.style.setProperty('--row', 6); placeholderLa.style.setProperty('--col', 3);
                placeholderLa.innerHTML = `<span>57-71</span><div class="category-lanthanide" style="width: 80%; height: 5px; margin-top: 2px;"></div>`;
                gameGrid.appendChild(placeholderLa);

                const placeholderAc = document.createElement('div');
                placeholderAc.className = 'grid-slot placeholder-slot';
                placeholderAc.style.setProperty('--row', 7); placeholderAc.style.setProperty('--col', 3);
                placeholderAc.innerHTML = `<span>89-103</span><div class="category-actinide" style="width: 80%; height: 5px; margin-top: 2px;"></div>`;
                gameGrid.appendChild(placeholderAc);

                elementsInGame.forEach(el => {
                    const pos = ELEMENT_POSITIONS[el.atomicNumber];
                    if (!pos) return;
                    const slot = document.createElement('div');
                    slot.className = 'grid-slot';
                    const categoryClass = categoryToClass[el.category];
                    if (categoryClass) {
                        slot.classList.add(`category-${categoryClass}`);
                    }
                    slot.dataset.category = el.category;
                    slot.dataset.atomicNumber = el.atomicNumber;
                    slot.textContent = el.atomicNumber;
                    slot.style.setProperty('--col', pos.col); slot.style.setProperty('--row', pos.row);
                    
                    slot.addEventListener('click', handleSlotClick);

                    const startPress = (e) => {
                        const targetSlot = e.currentTarget;
                        if (targetSlot.classList.contains('correct')) return;
                        longPressTimer = setTimeout(() => showCategoryTooltip(targetSlot), 500);
                    };

                    slot.addEventListener('mousedown', startPress);
                    slot.addEventListener('touchstart', startPress, { passive: true });
                    slot.addEventListener('mouseup', hideCategoryTooltip);
                    slot.addEventListener('mouseleave', hideCategoryTooltip);
                    slot.addEventListener('touchend', hideCategoryTooltip);

                    gameGrid.appendChild(slot);
                });
                populateColorLegend();
                displayNextQuestion();
            };

            const populateColorLegend = () => {
                const legendContainer = document.getElementById('color-legend');
                legendContainer.innerHTML = '';
                const legendMap = {
                    'โลหะแอลคาไล': 'var(--color-alkali-metal)', 'โลหะแอลคาไลน์เอิร์ท': 'var(--color-alkaline-earth)',
                    'แลนทาไนด์': 'var(--color-lanthanide)', 'แอกทิไนด์': 'var(--color-actinide)',
                    'โลหะทรานซิชัน': 'var(--color-transition-metal)', 'โลหะ': 'var(--color-metal)',
                    'เมทัลลอยด์': 'var(--color-metalloid)', 'นอนเมทัล': 'var(--color-nonmetal)',
                    'แฮโลเจน': 'var(--color-halogen)', 'ก๊าซมีตระกูล': 'var(--color-noble-gas)'
                };
                for (const [name, color] of Object.entries(legendMap)) {
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = `<div class="legend-color-box" style="background-color: ${color};"></div><span>${name}</span>`;
                    legendContainer.appendChild(item);
                }
            };
            
            const displayNextQuestion = () => {
                const questionBox = document.getElementById('question-display-box');
                questionBox.innerHTML = '';
                if (gameElementsQueue.length === 0) { 
                    endGame(); 
                    return; 
                }
                
                const correctElement = gameElementsQueue[0];
                const card = document.createElement('div');
                card.className = 'question-card';
                card.innerHTML = `<div class="symbol">${correctElement.symbol}</div><div class="name">${correctElement.name}</div>`;
                questionBox.appendChild(card);
            };

            const handleSlotClick = (e) => {
                const targetSlot = e.currentTarget;
                const targetAtomicNumber = parseInt(targetSlot.dataset.atomicNumber);

                if (gameElementsQueue.length > 0 && targetAtomicNumber === gameElementsQueue[0].atomicNumber) {
                    if (isAudioInitialized && correctSynth) correctSynth.triggerAttackRelease("G5", "16n");
                    score += 100;
                    const correctElement = gameElementsQueue[0];
                    targetSlot.classList.add('correct');
                    targetSlot.innerHTML = `<div class="element-symbol">${correctElement.symbol}</div><div class="element-name">${correctElement.name}</div>`;
                    targetSlot.removeEventListener('click', handleSlotClick);
                    showFeedback('✔', true);
                    gameElementsQueue.shift();
                    displayNextQuestion();
                } else {
                    if (isAudioInitialized && wrongSynth) wrongSynth.triggerAttackRelease("C3", "8n");
                    lives--;
                    showFeedback('✖', false);
                    if (lives <= 0) endGame();
                }
                updateUI();
            };
            
            const showCategoryTooltip = (slot) => {
                if (!slot || !slot.dataset) return; 
                const category = slot.dataset.category;
                if (!category) return;
                categoryTooltip.textContent = category;
                const rect = slot.getBoundingClientRect();
                const appRect = document.querySelector('.app-container').getBoundingClientRect();
                let top = rect.top - appRect.top - categoryTooltip.offsetHeight - 10;
                let left = rect.left - appRect.left + (rect.width / 2);
                categoryTooltip.style.top = `${top}px`;
                categoryTooltip.style.left = `${left}px`;
                categoryTooltip.style.display = 'block';
            };

            const hideCategoryTooltip = () => {
                clearTimeout(longPressTimer);
                categoryTooltip.style.display = 'none';
            };

            const displayNextSymbolQuestion = () => {
                if (gameElementsQueue.length === 0) { endGame(); return; }
                const correctElement = gameElementsQueue[0];
                document.getElementById('question-area').innerHTML = `ตัวย่อของธาตุ <span class="element-name">${correctElement.name}</span> คืออะไร?`;
                
                const choices = new Set([correctElement]);
                const distractorPool = ELEMENTS_DATA.filter(el => el.atomicNumber !== correctElement.atomicNumber);
                while (choices.size < 4 && distractorPool.length > 0) {
                    choices.add(distractorPool.splice(Math.floor(Math.random() * distractorPool.length), 1)[0]);
                }

                const optionsArea = document.getElementById('options-area');
                optionsArea.innerHTML = '';
                Array.from(choices).sort(() => Math.random() - 0.5).forEach(el => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = el.symbol;
                    btn.onclick = () => handleChoice(el.atomicNumber === correctElement.atomicNumber, displayNextSymbolQuestion);
                    optionsArea.appendChild(btn);
                });
            };
            
            const displayNextPropertyQuestion = () => {
                if (gameElementsQueue.length === 0) { endGame(); return; }
                const currentQuestion = gameElementsQueue[0];
                const { questionText, correctAnswer, choices } = currentQuestion;

                document.getElementById('question-area').innerHTML = questionText;
                
                const optionsArea = document.getElementById('options-area');
                optionsArea.innerHTML = '';
                choices.forEach(el => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = el.name;
                    btn.onclick = () => handleChoice(el.atomicNumber === correctAnswer.atomicNumber, displayNextPropertyQuestion);
                    optionsArea.appendChild(btn);
                });
            };

            const handleChoice = (isCorrect, nextQuestionFunc) => {
                if (isCorrect) {
                    if (isAudioInitialized && correctSynth) correctSynth.triggerAttackRelease("G5", "16n");
                    score += 100;
                    showFeedback('✔', true);
                    gameElementsQueue.shift();
                    nextQuestionFunc();
                } else {
                    if (isAudioInitialized && wrongSynth) wrongSynth.triggerAttackRelease("C3", "8n");
                    lives--;
                    showFeedback('✖', false);
                    if (lives <= 0) endGame();
                }
                updateUI();
            };

            const showFeedback = (text, isCorrect) => {
                const feedback = document.createElement('div');
                feedback.className = `feedback ${isCorrect ? 'correct' : 'wrong'}`;
                feedback.textContent = text;
                feedbackContainer.appendChild(feedback);
                setTimeout(() => feedback.remove(), 1000);
            };

            // --- Initial Setup ---
            populateCustomizationGrid();
            startGameBtn.addEventListener('click', startGame);
            
            playAgainBtn.addEventListener('click', async () => {
                await initAudio();
                if (isAudioInitialized && uiSynth) uiSynth.triggerAttackRelease("C5", "8n");
                
                if (gameState.mode === 'guess_property') {
                    showScreen('difficulty');
                } else {
                    showScreen('customization');
                }
            });

            homeBtn.addEventListener('click', returnToMainMenu);
            homeBtnGameOver.addEventListener('click', returnToMainMenu);
            homeBtnDifficulty.addEventListener('click', returnToMainMenu);
            homeBtnCustomization.addEventListener('click', returnToMainMenu);

            soundToggle.addEventListener('click', () => {
                if (!isAudioInitialized || typeof Tone === 'undefined') return;
                Tone.getDestination().mute = !Tone.getDestination().mute;
                soundToggle.classList.toggle('muted', Tone.getDestination().mute);

                if (!Tone.getDestination().mute && typeof Tone !== 'undefined' && Tone.Transport.state !== 'started' && screens.game.classList.contains('active')) {
                    Tone.Transport.start();
                    bgMusic.start(0);
                } else if (isAudioInitialized && typeof Tone !== 'undefined' && Tone.getDestination().mute) {
                    bgMusic.stop();
                    Tone.Transport.stop();
                }
            });
        });
    </script>
</body>
</html>

